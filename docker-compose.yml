services:
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: polysignal_app
    ports:
      - "${APP_PORT:-3000}:3000"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_USER=${DATABASE_USER}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}
      - DISCORD_CHANNEL_ID=${DISCORD_CHANNEL_ID}
      - DISCORD_NOTIFICATION_CHANNEL_ID=${DISCORD_NOTIFICATION_CHANNEL_ID}
      - DISCORD_POLITICS_CHANNEL_ID=${DISCORD_POLITICS_CHANNEL_ID}
      - DISCORD_CRYPTO_CHANNEL_ID=${DISCORD_CRYPTO_CHANNEL_ID}
      - DISCORD_SPORT_CHANNEL_ID=${DISCORD_SPORT_CHANNEL_ID}
      - DISCORD_SPORTS_CHANNEL_ID=${DISCORD_SPORTS_CHANNEL_ID}
      - DISCORD_ECONOMIC_CHANNEL_ID=${DISCORD_ECONOMIC_CHANNEL_ID}
      - DISCORD_WHALE_CHANNEL_ID=${DISCORD_WHALE_CHANNEL_ID}
      - DISCORD_WHALES_CHANNEL_ID=${DISCORD_WHALES_CHANNEL_ID}
      - DISCORD_FREE_CHANNEL_ID=${DISCORD_FREE_CHANNEL_ID}
      # Discord message field visibility (Regular traders)
      - DISCORD_SHOW_SHARES=${DISCORD_SHOW_SHARES:-false}
      - DISCORD_SHOW_TOTAL_SHARES=${DISCORD_SHOW_TOTAL_SHARES:-false}
      - DISCORD_SHOW_USD_VALUE=${DISCORD_SHOW_USD_VALUE:-false}
      - DISCORD_SHOW_VALUE_IN_TITLE=${DISCORD_SHOW_VALUE_IN_TITLE:-false}
      - DISCORD_SHOW_WHEN=${DISCORD_SHOW_WHEN:-true}
      - DISCORD_SHOW_TYPE=${DISCORD_SHOW_TYPE:-true}
      - DISCORD_SHOW_STATUS=${DISCORD_SHOW_STATUS:-true}
      - DISCORD_SHOW_PRICE=${DISCORD_SHOW_PRICE:-true}
      - DISCORD_SHOW_OUTCOME=${DISCORD_SHOW_OUTCOME:-true}
      - DISCORD_SHOW_ENTRY_PRICE=${DISCORD_SHOW_ENTRY_PRICE:-true}
      - DISCORD_SHOW_EXIT_PRICE=${DISCORD_SHOW_EXIT_PRICE:-true}
      - DISCORD_SHOW_REALIZED_PNL=${DISCORD_SHOW_REALIZED_PNL:-true}
      # Discord message field visibility (Whale category traders)
      - DISCORD_WHALE_SHOW_SHARES=${DISCORD_WHALE_SHOW_SHARES:-false}
      - DISCORD_WHALE_SHOW_TOTAL_SHARES=${DISCORD_WHALE_SHOW_TOTAL_SHARES:-false}
      - DISCORD_WHALE_SHOW_USD_VALUE=${DISCORD_WHALE_SHOW_USD_VALUE:-false}
      - DISCORD_WHALE_SHOW_VALUE_IN_TITLE=${DISCORD_WHALE_SHOW_VALUE_IN_TITLE:-false}
      - DISCORD_WHALE_SHOW_WHEN=${DISCORD_WHALE_SHOW_WHEN:-true}
      - DISCORD_WHALE_SHOW_TYPE=${DISCORD_WHALE_SHOW_TYPE:-true}
      - DISCORD_WHALE_SHOW_STATUS=${DISCORD_WHALE_SHOW_STATUS:-true}
      - DISCORD_WHALE_SHOW_PRICE=${DISCORD_WHALE_SHOW_PRICE:-true}
      - DISCORD_WHALE_SHOW_OUTCOME=${DISCORD_WHALE_SHOW_OUTCOME:-true}
      - DISCORD_WHALE_SHOW_ENTRY_PRICE=${DISCORD_WHALE_SHOW_ENTRY_PRICE:-true}
      - DISCORD_WHALE_SHOW_EXIT_PRICE=${DISCORD_WHALE_SHOW_EXIT_PRICE:-true}
      - DISCORD_WHALE_SHOW_REALIZED_PNL=${DISCORD_WHALE_SHOW_REALIZED_PNL:-true}
      # Discord status alert controls (Regular traders)
      - DISCORD_SEND_FOR_ADDED=${DISCORD_SEND_FOR_ADDED:-true}
      - DISCORD_SEND_FOR_OPEN=${DISCORD_SEND_FOR_OPEN:-true}
      - DISCORD_SEND_FOR_CLOSED=${DISCORD_SEND_FOR_CLOSED:-true}
      - DISCORD_SEND_FOR_PARTIALLY_CLOSED=${DISCORD_SEND_FOR_PARTIALLY_CLOSED:-true}
      # Discord status alert controls (Whale category traders)
      - DISCORD_WHALE_SEND_FOR_ADDED=${DISCORD_WHALE_SEND_FOR_ADDED:-true}
      - DISCORD_WHALE_SEND_FOR_OPEN=${DISCORD_WHALE_SEND_FOR_OPEN:-true}
      - DISCORD_WHALE_SEND_FOR_CLOSED=${DISCORD_WHALE_SEND_FOR_CLOSED:-true}
      - DISCORD_WHALE_SEND_FOR_PARTIALLY_CLOSED=${DISCORD_WHALE_SEND_FOR_PARTIALLY_CLOSED:-true}
      # Gainz alerts
      - DISCORD_GAINZ_CHANNEL_ID=${DISCORD_GAINZ_CHANNEL_ID}
      - DISCORD_GAINZ_THRESHOLD=${DISCORD_GAINZ_THRESHOLD:-50}
      # Gainz alert field visibility
      - DISCORD_GAINZ_SHOW_MARKET=${DISCORD_GAINZ_SHOW_MARKET:-true}
      - DISCORD_GAINZ_SHOW_TRADER=${DISCORD_GAINZ_SHOW_TRADER:-true}
      - DISCORD_GAINZ_SHOW_PROFIT_PERCENT=${DISCORD_GAINZ_SHOW_PROFIT_PERCENT:-true}
      - DISCORD_GAINZ_SHOW_ENTRY_PRICE=${DISCORD_GAINZ_SHOW_ENTRY_PRICE:-true}
      - DISCORD_GAINZ_SHOW_EXIT_PRICE=${DISCORD_GAINZ_SHOW_EXIT_PRICE:-true}
      - DISCORD_GAINZ_SHOW_OUTCOME=${DISCORD_GAINZ_SHOW_OUTCOME:-true}
      - DISCORD_GAINZ_SHOW_REALIZED_PNL=${DISCORD_GAINZ_SHOW_REALIZED_PNL:-true}
      - DISCORD_GAINZ_SHOW_POSITION_VALUE=${DISCORD_GAINZ_SHOW_POSITION_VALUE:-true}
      - DISCORD_GAINZ_SHOW_WHEN=${DISCORD_GAINZ_SHOW_WHEN:-true}
      - DISCORD_GAINZ_SHOW_CATEGORY=${DISCORD_GAINZ_SHOW_CATEGORY:-true}
      - DISCORD_GAINZ_SHOW_THUMBNAIL=${DISCORD_GAINZ_SHOW_THUMBNAIL:-true}
      - DISCORD_GAINZ_SHOW_FOOTER=${DISCORD_GAINZ_SHOW_FOOTER:-true}
      - DISCORD_GAINZ_SHOW_TIMESTAMP=${DISCORD_GAINZ_SHOW_TIMESTAMP:-true}
      # Arbitrage discovery threshold
      - ARBITRAGE_THRESHOLD=${ARBITRAGE_THRESHOLD:-97}
      # Whale frequency reset interval (in hours)
      - WHALE_FREQUENCY_RESET_HOURS=${WHALE_FREQUENCY_RESET_HOURS:-24}
      # Google Sheets integration
      - GOOGLE_SHEETS_ENABLED=${GOOGLE_SHEETS_ENABLED:-false}
      - GOOGLE_SERVICE_ACCOUNT_PATH=${GOOGLE_SERVICE_ACCOUNT_PATH:-./google-service-account.json}
      - GOOGLE_SHEETS_FREE_SPREADSHEET_ID=${GOOGLE_SHEETS_FREE_SPREADSHEET_ID}
      - GOOGLE_SHEETS_PAID_SPREADSHEET_ID=${GOOGLE_SHEETS_PAID_SPREADSHEET_ID}
      - GOOGLE_SHEETS_FREE_AGGREGATE_SPREADSHEET_ID=${GOOGLE_SHEETS_FREE_AGGREGATE_SPREADSHEET_ID}
      - GOOGLE_SHEETS_PAID_AGGREGATE_SPREADSHEET_ID=${GOOGLE_SHEETS_PAID_AGGREGATE_SPREADSHEET_ID}
      - GOOGLE_SHEETS_MAIN_SHEET_NAME=${GOOGLE_SHEETS_MAIN_SHEET_NAME:-CopyTrade Positions}
      - GOOGLE_SHEETS_AGGREGATE_SHEET_NAME=${GOOGLE_SHEETS_AGGREGATE_SHEET_NAME:-Summary}
      - GOOGLE_SHEETS_FOLDER_ID=${GOOGLE_SHEETS_FOLDER_ID}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - polysignal_network

  postgres:
    image: postgres:16-alpine
    container_name: polysignal_postgres
    ports:
      - "${DATABASE_PORT:-5432}:5432"
    environment:
      - POSTGRES_USER=${DATABASE_USER}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
      - POSTGRES_DB=${DATABASE_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - polysignal_network

  redis:
    image: redis:7-alpine
    container_name: polysignal_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - polysignal_network

volumes:
  postgres_data:
  redis_data:

networks:
  polysignal_network:
    driver: bridge

